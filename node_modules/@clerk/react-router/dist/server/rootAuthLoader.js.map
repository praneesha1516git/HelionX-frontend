{"version":3,"sources":["../../src/server/rootAuthLoader.ts"],"sourcesContent":["import type { RequestState } from '@clerk/backend/internal';\nimport { decorateObjectWithResources } from '@clerk/backend/internal';\nimport { logger } from '@clerk/shared/logger';\nimport type { LoaderFunctionArgs } from 'react-router';\n\nimport { invalidRootLoaderCallbackReturn, middlewareMigrationWarning } from '../utils/errors';\nimport { authFnContext, requestStateContext } from './clerkMiddleware';\nimport { legacyAuthenticateRequest } from './legacyAuthenticateRequest';\nimport { loadOptions } from './loadOptions';\nimport type {\n  LoaderFunctionArgsWithAuth,\n  LoaderFunctionReturn,\n  RootAuthLoaderCallback,\n  RootAuthLoaderOptions,\n} from './types';\nimport {\n  getResponseClerkState,\n  injectRequestStateIntoResponse,\n  isDataWithResponseInit,\n  IsOptIntoMiddleware,\n  isRedirect,\n  isResponse,\n} from './utils';\n\ninterface RootAuthLoader {\n  <Options extends RootAuthLoaderOptions, Callback extends RootAuthLoaderCallback<Options>>(\n    /**\n     * Arguments passed to the loader function.\n     */\n    args: LoaderFunctionArgs,\n    /**\n     * A loader function with authentication state made available to it. Allows you to fetch route data based on the user's authentication state.\n     */\n    callback: Callback,\n    options?: Options,\n  ): Promise<ReturnType<Callback>>;\n\n  (args: LoaderFunctionArgs, options?: RootAuthLoaderOptions): Promise<LoaderFunctionReturn>;\n}\n\n/**\n * Shared logic for processing the root auth loader with a given request state\n */\nasync function processRootAuthLoader(\n  args: LoaderFunctionArgs,\n  requestState: RequestState,\n  handler?: RootAuthLoaderCallback<any>,\n): Promise<LoaderFunctionReturn> {\n  const hasMiddleware = IsOptIntoMiddleware(args.context) && !!args.context.get(authFnContext);\n  const includeClerkHeaders = !hasMiddleware;\n\n  if (!handler) {\n    // if the user did not provide a handler, simply inject requestState into an empty response\n    const { clerkState } = getResponseClerkState(requestState, args.context);\n    return {\n      ...clerkState,\n    };\n  }\n\n  // Create args that has the auth object in the request for backward compatibility\n  const argsWithAuth = {\n    ...args,\n    request: Object.assign(args.request, { auth: requestState.toAuth() }),\n  } as LoaderFunctionArgsWithAuth<any>;\n\n  const handlerResult = await handler(argsWithAuth);\n\n  if (isResponse(handlerResult)) {\n    try {\n      // respect and pass-through any redirects without modifying them\n      if (isRedirect(handlerResult)) {\n        return handlerResult;\n      }\n      // clone and try to inject requestState into all json-like responses\n      // if this fails, the user probably didn't return a json object or a valid json string\n      return injectRequestStateIntoResponse(handlerResult, requestState, args.context, includeClerkHeaders);\n    } catch {\n      throw new Error(invalidRootLoaderCallbackReturn);\n    }\n  }\n\n  if (isDataWithResponseInit(handlerResult)) {\n    try {\n      // clone and try to inject requestState into all json-like responses\n      // if this fails, the user probably didn't return a json object or a valid json string\n      return injectRequestStateIntoResponse(\n        new Response(JSON.stringify(handlerResult.data), handlerResult.init ?? undefined),\n        requestState,\n        args.context,\n        includeClerkHeaders,\n      );\n    } catch {\n      throw new Error(invalidRootLoaderCallbackReturn);\n    }\n  }\n\n  // If the return value of the user's handler is null or a plain object\n  if (includeClerkHeaders) {\n    // Legacy path: return Response with headers\n    const responseBody = JSON.stringify(handlerResult ?? {});\n    return injectRequestStateIntoResponse(new Response(responseBody), requestState, args.context, includeClerkHeaders);\n  }\n\n  // Middleware path: return plain object with streaming support\n  const { clerkState } = getResponseClerkState(requestState, args.context);\n\n  return {\n    ...(handlerResult ?? {}),\n    ...clerkState,\n  };\n}\n\n/**\n * Makes authorization state available in your application by wrapping the root loader.\n *\n * @see https://clerk.com/docs/references/react-router/root-auth-loader\n */\nexport const rootAuthLoader: RootAuthLoader = async (\n  args: LoaderFunctionArgs,\n  handlerOrOptions: any,\n  options?: any,\n): Promise<LoaderFunctionReturn> => {\n  const handler = typeof handlerOrOptions === 'function' ? handlerOrOptions : undefined;\n  const opts: RootAuthLoaderOptions = options\n    ? options\n    : !!handlerOrOptions && typeof handlerOrOptions !== 'function'\n      ? handlerOrOptions\n      : {};\n\n  const hasMiddlewareFlag = IsOptIntoMiddleware(args.context);\n  const requestState = hasMiddlewareFlag && args.context.get(requestStateContext);\n\n  if (!requestState) {\n    logger.warnOnce(middlewareMigrationWarning);\n    return legacyRootAuthLoader(args, handlerOrOptions, opts);\n  }\n\n  return processRootAuthLoader(args, requestState, handler);\n};\n\n/**\n * Legacy implementation that authenticates requests without middleware.\n * This maintains backward compatibility for users who haven't migrated to the new middleware system.\n */\nconst legacyRootAuthLoader: RootAuthLoader = async (\n  args: LoaderFunctionArgs,\n  handlerOrOptions: any,\n  options?: any,\n): Promise<LoaderFunctionReturn> => {\n  const handler = typeof handlerOrOptions === 'function' ? handlerOrOptions : undefined;\n  const opts: RootAuthLoaderOptions = options\n    ? options\n    : !!handlerOrOptions && typeof handlerOrOptions !== 'function'\n      ? handlerOrOptions\n      : {};\n\n  const loadedOptions = loadOptions(args, opts);\n  // Note: legacyAuthenticateRequest() will throw a redirect if the auth state is determined to be handshake\n  const _requestState = await legacyAuthenticateRequest(args, loadedOptions);\n  const requestState = { ...loadedOptions, ..._requestState };\n\n  if (!handler) {\n    // if the user did not provide a handler, simply inject requestState into an empty response\n    return injectRequestStateIntoResponse(new Response(JSON.stringify({})), requestState, args.context, true);\n  }\n\n  const authObj = requestState.toAuth();\n  const requestWithAuth = Object.assign(args.request, { auth: authObj });\n  await decorateObjectWithResources(requestWithAuth, authObj, loadedOptions);\n\n  return processRootAuthLoader(args, requestState, handler);\n};\n"],"mappings":";AACA,SAAS,mCAAmC;AAC5C,SAAS,cAAc;AAGvB,SAAS,iCAAiC,kCAAkC;AAC5E,SAAS,eAAe,2BAA2B;AACnD,SAAS,iCAAiC;AAC1C,SAAS,mBAAmB;AAO5B;AAAA,EACE;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,OACK;AAqBP,eAAe,sBACb,MACA,cACA,SAC+B;AA/CjC;AAgDE,QAAM,gBAAgB,oBAAoB,KAAK,OAAO,KAAK,CAAC,CAAC,KAAK,QAAQ,IAAI,aAAa;AAC3F,QAAM,sBAAsB,CAAC;AAE7B,MAAI,CAAC,SAAS;AAEZ,UAAM,EAAE,YAAAA,YAAW,IAAI,sBAAsB,cAAc,KAAK,OAAO;AACvE,WAAO;AAAA,MACL,GAAGA;AAAA,IACL;AAAA,EACF;AAGA,QAAM,eAAe;AAAA,IACnB,GAAG;AAAA,IACH,SAAS,OAAO,OAAO,KAAK,SAAS,EAAE,MAAM,aAAa,OAAO,EAAE,CAAC;AAAA,EACtE;AAEA,QAAM,gBAAgB,MAAM,QAAQ,YAAY;AAEhD,MAAI,WAAW,aAAa,GAAG;AAC7B,QAAI;AAEF,UAAI,WAAW,aAAa,GAAG;AAC7B,eAAO;AAAA,MACT;AAGA,aAAO,+BAA+B,eAAe,cAAc,KAAK,SAAS,mBAAmB;AAAA,IACtG,QAAQ;AACN,YAAM,IAAI,MAAM,+BAA+B;AAAA,IACjD;AAAA,EACF;AAEA,MAAI,uBAAuB,aAAa,GAAG;AACzC,QAAI;AAGF,aAAO;AAAA,QACL,IAAI,SAAS,KAAK,UAAU,cAAc,IAAI,IAAG,mBAAc,SAAd,YAAsB,MAAS;AAAA,QAChF;AAAA,QACA,KAAK;AAAA,QACL;AAAA,MACF;AAAA,IACF,QAAQ;AACN,YAAM,IAAI,MAAM,+BAA+B;AAAA,IACjD;AAAA,EACF;AAGA,MAAI,qBAAqB;AAEvB,UAAM,eAAe,KAAK,UAAU,wCAAiB,CAAC,CAAC;AACvD,WAAO,+BAA+B,IAAI,SAAS,YAAY,GAAG,cAAc,KAAK,SAAS,mBAAmB;AAAA,EACnH;AAGA,QAAM,EAAE,WAAW,IAAI,sBAAsB,cAAc,KAAK,OAAO;AAEvE,SAAO;AAAA,IACL,GAAI,wCAAiB,CAAC;AAAA,IACtB,GAAG;AAAA,EACL;AACF;AAOO,IAAM,iBAAiC,OAC5C,MACA,kBACA,YACkC;AAClC,QAAM,UAAU,OAAO,qBAAqB,aAAa,mBAAmB;AAC5E,QAAM,OAA8B,UAChC,UACA,CAAC,CAAC,oBAAoB,OAAO,qBAAqB,aAChD,mBACA,CAAC;AAEP,QAAM,oBAAoB,oBAAoB,KAAK,OAAO;AAC1D,QAAM,eAAe,qBAAqB,KAAK,QAAQ,IAAI,mBAAmB;AAE9E,MAAI,CAAC,cAAc;AACjB,WAAO,SAAS,0BAA0B;AAC1C,WAAO,qBAAqB,MAAM,kBAAkB,IAAI;AAAA,EAC1D;AAEA,SAAO,sBAAsB,MAAM,cAAc,OAAO;AAC1D;AAMA,IAAM,uBAAuC,OAC3C,MACA,kBACA,YACkC;AAClC,QAAM,UAAU,OAAO,qBAAqB,aAAa,mBAAmB;AAC5E,QAAM,OAA8B,UAChC,UACA,CAAC,CAAC,oBAAoB,OAAO,qBAAqB,aAChD,mBACA,CAAC;AAEP,QAAM,gBAAgB,YAAY,MAAM,IAAI;AAE5C,QAAM,gBAAgB,MAAM,0BAA0B,MAAM,aAAa;AACzE,QAAM,eAAe,EAAE,GAAG,eAAe,GAAG,cAAc;AAE1D,MAAI,CAAC,SAAS;AAEZ,WAAO,+BAA+B,IAAI,SAAS,KAAK,UAAU,CAAC,CAAC,CAAC,GAAG,cAAc,KAAK,SAAS,IAAI;AAAA,EAC1G;AAEA,QAAM,UAAU,aAAa,OAAO;AACpC,QAAM,kBAAkB,OAAO,OAAO,KAAK,SAAS,EAAE,MAAM,QAAQ,CAAC;AACrE,QAAM,4BAA4B,iBAAiB,SAAS,aAAa;AAEzE,SAAO,sBAAsB,MAAM,cAAc,OAAO;AAC1D;","names":["clerkState"]}