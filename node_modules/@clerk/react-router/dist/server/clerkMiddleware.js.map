{"version":3,"sources":["../../src/server/clerkMiddleware.ts"],"sourcesContent":["import type { AuthObject } from '@clerk/backend';\nimport type { RequestState } from '@clerk/backend/internal';\nimport { AuthStatus, constants, createClerkRequest } from '@clerk/backend/internal';\nimport { handleNetlifyCacheInDevInstance } from '@clerk/shared/netlifyCacheHandler';\nimport type { PendingSessionOptions } from '@clerk/types';\nimport type { MiddlewareFunction } from 'react-router';\nimport { createContext } from 'react-router';\n\nimport { clerkClient } from './clerkClient';\nimport { loadOptions } from './loadOptions';\nimport type { ClerkMiddlewareOptions } from './types';\nimport { patchRequest } from './utils';\n\nexport const authFnContext = createContext<((options?: PendingSessionOptions) => AuthObject) | null>(null);\nexport const requestStateContext = createContext<RequestState<any> | null>(null);\n\n/**\n * Middleware that integrates Clerk authentication into your React Router application.\n * It checks the request's cookies and headers for a session JWT and, if found,\n * attaches the Auth object to a context.\n *\n * @example\n * // react-router.config.ts\n * export default {\n *   future: {\n *     v8_middleware: true,\n *   },\n * }\n *\n * // root.tsx\n * export const middleware: Route.MiddlewareFunction[] = [clerkMiddleware()]\n */\nexport const clerkMiddleware = (options?: ClerkMiddlewareOptions): MiddlewareFunction<Response> => {\n  return async (args, next) => {\n    const clerkRequest = createClerkRequest(patchRequest(args.request));\n    const loadedOptions = loadOptions(args, options);\n\n    // Pick only the properties needed by authenticateRequest.\n    // Used when manually providing options to the middleware.\n    const {\n      apiUrl,\n      secretKey,\n      jwtKey,\n      proxyUrl,\n      isSatellite,\n      domain,\n      publishableKey,\n      machineSecretKey,\n      audience,\n      authorizedParties,\n      signInUrl,\n      signUpUrl,\n      afterSignInUrl,\n      afterSignUpUrl,\n      organizationSyncOptions,\n    } = loadedOptions;\n\n    const requestState = await clerkClient(args, options).authenticateRequest(clerkRequest, {\n      apiUrl,\n      secretKey,\n      jwtKey,\n      proxyUrl,\n      isSatellite,\n      domain,\n      publishableKey,\n      machineSecretKey,\n      audience,\n      authorizedParties,\n      organizationSyncOptions,\n      signInUrl,\n      signUpUrl,\n      afterSignInUrl,\n      afterSignUpUrl,\n      acceptsToken: 'any',\n    });\n\n    const locationHeader = requestState.headers.get(constants.Headers.Location);\n    if (locationHeader) {\n      handleNetlifyCacheInDevInstance({\n        locationHeader,\n        requestStateHeaders: requestState.headers,\n        publishableKey: requestState.publishableKey,\n      });\n      // Trigger a handshake redirect\n      return new Response(null, { status: 307, headers: requestState.headers });\n    }\n\n    if (requestState.status === AuthStatus.Handshake) {\n      throw new Error('Clerk: handshake status without redirect');\n    }\n\n    args.context.set(authFnContext, (options?: PendingSessionOptions) => requestState.toAuth(options));\n    args.context.set(requestStateContext, requestState);\n\n    const response = await next();\n\n    if (requestState.headers) {\n      requestState.headers.forEach((value, key) => {\n        response.headers.append(key, value);\n      });\n    }\n\n    return response;\n  };\n};\n"],"mappings":";AAEA,SAAS,YAAY,WAAW,0BAA0B;AAC1D,SAAS,uCAAuC;AAGhD,SAAS,qBAAqB;AAE9B,SAAS,mBAAmB;AAC5B,SAAS,mBAAmB;AAE5B,SAAS,oBAAoB;AAEtB,IAAM,gBAAgB,cAAwE,IAAI;AAClG,IAAM,sBAAsB,cAAwC,IAAI;AAkBxE,IAAM,kBAAkB,CAAC,YAAmE;AACjG,SAAO,OAAO,MAAM,SAAS;AAC3B,UAAM,eAAe,mBAAmB,aAAa,KAAK,OAAO,CAAC;AAClE,UAAM,gBAAgB,YAAY,MAAM,OAAO;AAI/C,UAAM;AAAA,MACJ;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF,IAAI;AAEJ,UAAM,eAAe,MAAM,YAAY,MAAM,OAAO,EAAE,oBAAoB,cAAc;AAAA,MACtF;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA,cAAc;AAAA,IAChB,CAAC;AAED,UAAM,iBAAiB,aAAa,QAAQ,IAAI,UAAU,QAAQ,QAAQ;AAC1E,QAAI,gBAAgB;AAClB,sCAAgC;AAAA,QAC9B;AAAA,QACA,qBAAqB,aAAa;AAAA,QAClC,gBAAgB,aAAa;AAAA,MAC/B,CAAC;AAED,aAAO,IAAI,SAAS,MAAM,EAAE,QAAQ,KAAK,SAAS,aAAa,QAAQ,CAAC;AAAA,IAC1E;AAEA,QAAI,aAAa,WAAW,WAAW,WAAW;AAChD,YAAM,IAAI,MAAM,0CAA0C;AAAA,IAC5D;AAEA,SAAK,QAAQ,IAAI,eAAe,CAACA,aAAoC,aAAa,OAAOA,QAAO,CAAC;AACjG,SAAK,QAAQ,IAAI,qBAAqB,YAAY;AAElD,UAAM,WAAW,MAAM,KAAK;AAE5B,QAAI,aAAa,SAAS;AACxB,mBAAa,QAAQ,QAAQ,CAAC,OAAO,QAAQ;AAC3C,iBAAS,QAAQ,OAAO,KAAK,KAAK;AAAA,MACpC,CAAC;AAAA,IACH;AAEA,WAAO;AAAA,EACT;AACF;","names":["options"]}